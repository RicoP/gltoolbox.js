<!doctype html>
<html class="no-js" lang="en">
<head>
	<meta charset="utf-8">
	<meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
	<meta name="viewport" content="width=device-width">
</head>
<body>
<canvas width="640" height="480"></canvas> 
<script src="gl-matrix.js"></script>
<script src="../../glt.js"></script> 
<script>
(function() { 
"use strict"; 

var gl = GLT.createSafeContext(document.getElementsByTagName("canvas")[0]); 
var program = null; 
var texture = null; 

var projection = mat4.perspective(75, 4/3, 0.1, 8); 
var modelview = mat4.identity(); 
var entity = null; 

GLT.loadmanager.loadFiles({
	"files" : [
		"RaspPi_Board_ModelB.obj", 
		"tex.png", 
		"shader.vs", 
		"shader.fs"
	], 
	"finished" : function(files) {
		setup(files); 
		GLT.requestGameFrame(draw); 
	},	
	"error" : function(file, message) {
		console.log(file, message); 
	}
});

function setup(files) {
	entity = files["house.obj"]; 

	gl.enable( gl.DEPTH_TEST ); 
	
	var vertexShader = gl.createShader(gl.VERTEX_SHADER); 
	gl.shaderSource(vertexShader, files["shader.vs"]);
	gl.compileShader(vertexShader); 
	console.log( gl.getShaderInfoLog(vertexShader) ); 

	var fragmentShader = gl.createShader(gl.FRAGMENT_SHADER); 
	gl.shaderSource(fragmentShader, files["shader.fs"]);
	gl.compileShader(fragmentShader); 
	console.log( gl.getShaderInfoLog(fragmentShader) ); 

	program = gl.createProgram(); 

	gl.attachShader(program, vertexShader); 
	gl.attachShader(program, fragmentShader); 
	gl.linkProgram(program); 

	console.log( gl.getProgramInfoLog(program) ); 

	var vtnBuffer = gl.createBuffer(); 
	gl.bindBuffer(gl.ARRAY_BUFFER, vtnBuffer); 
	gl.bufferData(gl.ARRAY_BUFFER, entity.rawData, gl.STATIC_DRAW); 
	
	//attribute vec4 vPosition;
	gl.vertexAttribPointer(0, 4, gl.FLOAT, false, entity.stride, entity.voffset);
	gl.enableVertexAttribArray(0); 

	//attribute vec2 vTextureCoord;
	gl.vertexAttribPointer(1, 2, gl.FLOAT, false, entity.stride, entity.toffset);
	gl.enableVertexAttribArray(1); 

	//attribute vec4 vNormal;
	gl.vertexAttribPointer(2, 4, gl.FLOAT, false, entity.stride, entity.noffset);
	gl.enableVertexAttribArray(2); 

	gl.useProgram(program); 

	var img = files["tex.png"]; 
	
	texture = gl.createTexture(); 
	gl.bindTexture(gl.TEXTURE_2D, texture); 
	gl.texImage2D(gl.TEXTURE_2D, 0, gl.RGBA, gl.RGBA, gl.UNSIGNED_BYTE, img);
	gl.texParameteri(gl.TEXTURE_2D, gl.TEXTURE_MAG_FILTER, gl.LINEAR);
	gl.texParameteri(gl.TEXTURE_2D, gl.TEXTURE_MIN_FILTER, gl.LINEAR);
	gl.bindTexture(gl.TEXTURE_2D, null);
}

function draw(time) {
	gl.clearColor(0,0,0,1); 
	gl.clear(gl.COLOR_BUFFER_BIT | gl.DEPTH_BUFFER_BIT); 

	var indxModelView  = gl.getUniformLocation(program, "vModelView") 
	var indxProjection = gl.getUniformLocation(program, "vProjection");
	var indxTexture    = gl.getUniformLocation(program, "texture"); 

	modelview = mat4.identity(); 
	mat4.translate(modelview, [0, 0, -3]); 
	mat4.rotateX(modelview, Date.now() / 1000);
	mat4.rotateZ(modelview, Date.now() / 1500);

	gl.bindTexture(gl.TEXTURE_2D, texture); 
	gl.uniform1i(indxTexture, 0); 

	gl.uniformMatrix4fv(indxProjection, false, projection); 
	gl.uniformMatrix4fv(indxModelView, false, modelview); 

	gl.drawArrays(gl.TRIANGLES, 0, entity.numVertices); 

	GLT.requestGameFrame(draw); 
}
}()); 
</script> 
</body>
</html>

